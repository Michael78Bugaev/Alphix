# Реализация getch_handler и kgetch

## Обзор

Реализованы функции для работы с клавиатурой в стиле POSIX:

- `getch_handler()` - обработчик прерываний клавиатуры
- `kgetch()` - функция для получения одного символа с клавиатуры

## Реализованные функции

### getch_handler(cpu_registers_t *regs)

Обработчик прерываний клавиатуры, который:

1. **Читает скан-код** из порта 0x60
2. **Обрабатывает модификаторы** (Shift, Ctrl, Alt, Caps Lock)
3. **Обрабатывает специальные клавиши**:
   - Enter → '\n'
   - Backspace → '\b'
   - Tab → '\t'
   - Escape → 27
   - Стрелки → коды 72, 80, 75, 77
   - F1-F12 → коды 59-70
4. **Обрабатывает обычные символы** с учетом Shift и Caps Lock
5. **Устанавливает флаг** `getch_end = 1` при получении символа

### kgetch()

Функция для получения одного символа с клавиатуры:

1. **Сбрасывает состояние** (`getch_end = 0`, `getch_char = 0`)
2. **Регистрирует обработчик** прерывания клавиатуры
3. **Ждет нажатия** клавиши (пока `getch_end != 1`)
4. **Отключает обработчик** прерывания
5. **Возвращает символ** из `getch_char`

## Используемые переменные

- `getch_end` - флаг завершения ожидания
- `getch_char` - полученный символ
- `shift`, `ctrl`, `alt`, `capslock` - состояние модификаторов

## Поддерживаемые клавиши

### Обычные символы
- Все буквы (A-Z, a-z)
- Все цифры (0-9)
- Специальные символы (зависят от раскладки)

### Специальные клавиши
- **Enter** → '\n'
- **Backspace** → '\b'
- **Tab** → '\t'
- **Escape** → 27
- **Стрелки** → 72 (↑), 80 (↓), 75 (←), 77 (→)
- **F1-F12** → 59-70

### Модификаторы
- **Shift** - переключение регистра
- **Caps Lock** - фиксация верхнего регистра
- **Ctrl** - зарезервировано для будущих функций
- **Alt** - зарезервировано для будущих функций

## Пример использования

```c
// В kernel_main или другом месте ядра
kprintf("Нажмите любую клавишу...\n");
int c = kgetch();
kprintf("Вы нажали: %c (код: %d)\n", c, c);

// Обработка специальных клавиш
if (c == '\n') {
    kprintf("Нажат Enter\n");
} else if (c == 27) {
    kprintf("Нажат Escape\n");
} else if (c >= 59 && c <= 70) {
    kprintf("Нажата функциональная клавиша F%d\n", c - 58);
}
```

## Совместимость с POSIX

Функция `kgetch()` работает аналогично функции `getch()` из библиотеки ncurses:

- Блокирующий вызов (ждет нажатия клавиши)
- Возвращает код символа
- Поддерживает специальные клавиши
- Не требует эхо-вывода

## Технические детали

### Прерывания
- Используется IRQ 1 (клавиатура)
- Обработчик регистрируется через `idt_register_handler(33, getch_handler)`
- Отключается через `idt_uninstall_handler(33)`

### Порты ввода-вывода
- Чтение скан-кода: `inb(0x60)`
- Определение нажатия/отпускания: бит 7 скан-кода

### ASCII-преобразование
- Используются функции `get_acsii_low()` и `get_acsii_high()`
- Учитывается состояние Shift и Caps Lock

## Статус реализации

✅ **Полностью реализовано и протестировано**

- [x] getch_handler() - обработчик прерываний
- [x] kgetch() - функция получения символа
- [x] Поддержка обычных символов
- [x] Поддержка специальных клавиш
- [x] Обработка модификаторов
- [x] Совместимость с POSIX
- [x] Компиляция без ошибок
- [x] Базовое тестирование

## Готовность к использованию

Функции готовы к использованию в ядре Alphix. Первый человек в команде может использовать `kgetch()` для интерактивного ввода в приложениях ядра. 